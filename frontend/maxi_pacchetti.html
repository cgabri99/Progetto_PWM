<!doctype html>
<html lang="it" data-bs-theme="dark">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Maxi pacchetti</title>
    <script type="text/javascript" src="../backend/script.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body onload="aggiornaPagina();">
    <div class="vh-100">
        <div class="container py-5 h-100">
            <div class="row d-flex justify-content-center align-items-center h-100">
                <div class="col">
                    <a class="btn btn-lg btn-primary mb-2" type="button" href="home.html">Home</a>
                    <div id="error" class="d-none my-3 p-3 alert alert-danger" role="alert">
                    </div>
                    <div class="card" style="border-radius: 1rem;">
                        <div class="card-body p-5 text-center">
                            <div id="admin" class="d-none my-3">

                                <h1 class="text-center">Creazione offerta maxi pacchetto</h1>
                                <p>In questa sezione l'amministratore può generare offerte per dei <strong>maxi
                                        pacchetti</strong>
                                    di figurine. Un <strong>maxi pacchetto</strong> può contenere da 6 a 30 figurine, e
                                    il suo prezzo può andare da 1 a 5 crediti</p>
                                <div class="input-group mb-3">
                                    <label class="input-group-text" for="price">Prezzo dell'offerta (in crediti)
                                    </label>
                                    <input id="price" class="col input-group-text border" type="number" min="1" max="5">
                                    </select>
                                </div>
                                <div class="input-group mb-3">
                                    <label class="input-group-text" for="nFigurine">Quantità di figurine nel pacchetto
                                    </label>
                                    <input id="nFigurine" class="col input-group-text border" type="number" min="6"
                                        max="30">
                                    </select>
                                </div>

                                <button type="button" class="btn btn-lg btn-primary" onclick="creaOfferta()">Crea
                                    offerta</button>

                            </div>

                            <div id="user" class="d-none text-center my-3">
                                <h1>Acquisto maxi pacchetto</h1>
                                <p>In questa sezione l'utente può acquistare dei <strong>maxi pacchetti</strong> di
                                    figurine. Un <strong>maxi pacchetto</strong> può contenere da 6 a 30 figurine, e
                                    il suo prezzo può andare da 1 a 5 crediti
                                </p>
                                <table id="offerte" class="table">
                                    <thead>
                                        <tr>
                                            <th scope="col">#</th>
                                            <th scope="col">Prezzo</th>
                                            <th scope="col">Quantità di figurine</th>
                                            <th scope="col">Accetta offertra</th>
                                        </tr>
                                    </thead>
                                    <tbody id="offerteBody" class="table-group-divider">
                                        <tr id="offerteRow" class="d-none">
                                            <th id="count" scope="row"></th>
                                            <td id="price"></td>
                                            <td id="qty"></td>
                                            <td id="accetta">
                                                <button class="btn btn-primary mb-2" type="button"
                                                    onclick="accettaOfferta(this)">Accetta offerta</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script>
        const error = document.getElementById("error");
        function aggiornaPagina() {
            checkLoggedInUser();
            checkIsAdmin();
        }

        function checkIsAdmin() {
            const requestOptions = {
                method: "GET",
                redirect: "follow"
            };

            fetch(`http://localhost:3000/users/${getLocalStorage("id_utente")}`, requestOptions)
                .then((response) => response.text())
                .then((result) => JSON.parse(result))
                .then((user) => {
                    if (user.nome === "admin" && user.cognome === "admin" && user.email === "admin@admin.it") {
                        document.getElementById("admin").classList.remove("d-none");
                    } else {
                        document.getElementById("user").classList.remove("d-none");
                        getOfferte();
                    }
                })
                .catch((error) => console.error(error));
        }

        async function getOfferte() {
            const requestOptions = {
                method: "GET",
                redirect: "follow"
            };

            const request = await fetch("http://localhost:3000/maxiPacchetti", requestOptions);
            const response = await request.text();
            const offerte = await JSON.parse(response).offerte;
            console.log(offerte);
            if (offerte.length === 0) {
                document.getElementById("offerte").classList.add("d-none");
                document.getElementById("user").innerHTML += "<h4>Non ci sono offerte disponibili al momento</h4>";
                return;
            } else {
                offerte.forEach((offerta, index) => {
                    const offerteBody = document.getElementById("offerteBody");
                    const offerteRow = document.getElementById("offerteRow").cloneNode(true);
                    offerteRow.id = `offerteRow${index}`;
                    offerteRow.classList.remove("d-none");
                    offerteRow.querySelector("#count").innerHTML = index + 1;
                    offerteRow.querySelector("#price").innerHTML = offerta.price;
                    offerteRow.querySelector("#qty").innerHTML = offerta.n_figurine;
                    offerteRow.querySelector("#accetta").querySelector("button").setAttribute("data-id", offerta._id);
                    offerteBody.appendChild(offerteRow);
                });
            }
        }

        function accettaOfferta(btn) {
            const myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");

            const raw = JSON.stringify({
                "id_offerta": btn.getAttribute("data-id"),
                "id_acquirente": getLocalStorage("id_utente")
            });

            const requestOptions = {
                method: "DELETE",
                headers: myHeaders,
                body: raw,
                redirect: "follow"
            };

            fetch("http://localhost:3000/maxiPacchetti", requestOptions)
                .then((response) => response.text())
                .then((result) => JSON.parse(result))
                .then((offerta) => {
                    const bottoni = document.getElementsByClassName("btn");
                    for (let i = 0; i < bottoni.length; i++) {
                        bottoni[i].classList.add("disabled");
                    }
                    error.classList.remove("d-none", "alert-danger", "alert-success");
                    error.classList.add("alert-warning");
                    error.innerHTML = "Acquisto in corso attendere...";
                    console.log(offerta);
                    aggiungiFigurine(offerta.offerta.n_figurine);
                })
                .catch((e) => {
                    console.error(e);
                    error.classList.remove("d-none");
                    error.classList.add("alert-danger");
                    error.innerHTML = "Non hai abbastanza crediti per acquistare questa bustina!";
                });
        }

        function aggiungiFigurine(nFigurine) {
            acquistaPacchetto(nFigurine)
                .then((figurine) => {
                    const requestOptions = {
                        method: "PUT",
                        redirect: "follow",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: `{"figurine": ${JSON.stringify(figurine)}}`
                    };
                    fetch(`http://localhost:3000/figurine/${getLocalStorage("id_utente")}`, requestOptions)
                        .then((response) => response.text())
                        .then(() => {
                            error.classList.remove('d-none', 'alert-danger', 'alert-warning');
                            error.classList.add('alert-success');
                            error.innerHTML = 'Acquisto completato!';
                            const bottoni = document.getElementsByClassName("btn");
                            for (let i = 0; i < bottoni.length; i++) {
                                bottoni[i].classList.remove("disabled");
                            }
                            getOfferte();
                        })
                        .catch((e) => console.error(e));
                });

        }

        function creaOfferta() {
            const price = document.getElementById("price");
            const nFigurine = document.getElementById("nFigurine");

            if (!price.checkValidity() || !price.value) {
                error.classList.remove("d-none");
                error.innerHTML = "Inserire un prezzo valido, minimo 1 massimo 5 crediti!";
                price.focus();
                price.classList.add("border-danger");
                return;
            } else if (!nFigurine.checkValidity() || !nFigurine.value) {
                error.classList.remove("d-none");
                error.innerHTML = "Inserire un numero di figurine valido, minimo 6 massimo 30 figurine!";
                nFigurine.focus();
                nFigurine.classList.add("border-danger");
                return;
            } else {
                error.classList.add("d-none");
                nFigurine.classList.remove("border-danger");
                price.classList.remove("border-danger");
            }

            const myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");

            const raw = JSON.stringify({
                "admin": getLocalStorage("id_utente"),
                "n_figurine": parseInt(nFigurine.value),
                "price": parseInt(price.value)
            });

            const requestOptions = {
                method: "POST",
                headers: myHeaders,
                body: raw,
                redirect: "follow"
            };

            fetch("http://localhost:3000/maxiPacchetti", requestOptions)
                .then((response) => response.text())
                .then((result) => JSON.parse(result))
                .then((result) => {
                    if (!result.error) {
                        error.classList.remove("d-none", "alert-danger", "alert-warning");
                        error.classList.add("alert-success");
                        error.innerHTML = "Offerta creata con successo!";
                    } else {
                        error.classList.remove("d-none", "alert-success", "alert-warning");
                        error.classList.add("alert-danger");
                        error.innerHTML = result.error;
                    }
                })
                .catch((e) => {
                    console.error(e);
                });
        }
    </script>
</body>


</html>