<!doctype html>
<html lang="it" data-bs-theme="dark">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Maxi pacchetti</title>
    <script type="text/javascript" src="../backend/script.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body onload="aggiornaNavbar();loadPagina();">
    <div class="vh-100">
        <nav class="navbar bg-dark border-bottom border-body navbar-expand-lg">
            <div class="container-fluid">
                <a class="navbar-brand" href="home.html">Album delle Figurine dei Super Eroi (AFSE)</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item dropdown">
                            <a id="menuFigurine" class="nav-link dropdown-toggle disabled" href="#" role="button"
                                data-bs-toggle="dropdown">
                                Gestione figurine
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="album.html">Album</a></li>
                                <li><a class="dropdown-item" href="crea_scambio.html">Crea Scambio</a></li>
                                <li><a class="dropdown-item" href="lista_scambi.html">Scambi disponibili</a></li>
                                <li><a class="dropdown-item" href="acquisto_bustine.html">Acquisto bustine</a></li>
                                <li><a class="dropdown-item" href="maxi_pacchetti.html">Maxi pacchetti</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a id="menuUtente" class="nav-link dropdown-toggle disabled" href="#" role="button"
                                data-bs-toggle="dropdown">
                                Gestione utente
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="modifica_utente.html">Modifica dati</a></li>
                                <li><a class="dropdown-item" href="elimina_utente.html">Elimina Utente</a></li>
                                <li><a class="dropdown-item" href="#" onclick="sign_out();">Log out</a></li>
                                <li><a class="dropdown-item" href="login.html">Log in</a></li>
                            </ul>
                        </li>
                    </ul>
                    <span id="benvenuto" class="navbar-text mx-3 d-none"></span>
                    <a id="salvadanaio" class="btn btn-outline-light d-none" type="button"
                        href="acquisto_crediti.html"></a>
                </div>
            </div>
        </nav>

        <div class="container py-5 h-100">
            <div class="row d-flex justify-content-center align-items-center h-100">
                <div class="col">
                    <div id="error" class="d-none my-3 p-3 alert alert-danger" role="alert">
                    </div>
                    <div class="card" style="border-radius: 1rem;">
                        <div class="card-body p-5 text-center">
                            <div id="admin" class="d-none my-3">

                                <h1 class="text-center">Creazione offerta maxi pacchetto</h1>
                                <p>In questa sezione l'amministratore può generare offerte per dei <strong>maxi
                                        pacchetti</strong>
                                    di figurine. Un <strong>maxi pacchetto</strong> può contenere da 6 a 30 figurine, e
                                    il suo prezzo può andare da 1 a 5 crediti</p>
                                <div class="input-group mb-3">
                                    <label class="input-group-text" for="price">Prezzo dell'offerta (in crediti)
                                    </label>
                                    <input id="price" class="col input-group-text border" type="number" min="1" max="5">
                                    </select>
                                </div>
                                <div class="input-group mb-3">
                                    <label class="input-group-text" for="nFigurine">Quantità di figurine nel pacchetto
                                    </label>
                                    <input id="nFigurine" class="col input-group-text border" type="number" min="6"
                                        max="30">
                                    </select>
                                </div>

                                <button type="button" class="btn btn-lg btn-primary" onclick="creaOfferta()">Crea
                                    offerta</button>

                            </div>

                            <div id="user" class="d-none text-center my-3">
                                <h1>Acquisto maxi pacchetto</h1>
                                <p>In questa sezione l'utente può acquistare dei <strong>maxi pacchetti</strong> di
                                    figurine. Un <strong>maxi pacchetto</strong> può contenere da 6 a 30 figurine, e
                                    il suo prezzo può andare da 1 a 5 crediti
                                </p>
                                <table id="offerte" class="table d-none">
                                    <thead>
                                        <tr>
                                            <th scope="col">#</th>
                                            <th scope="col">Prezzo</th>
                                            <th scope="col">Quantità di figurine</th>
                                            <th scope="col">Accetta offertra</th>
                                        </tr>
                                    </thead>
                                    <tbody id="offerteBody" class="table-group-divider">
                                        <tr id="offerteRow" class="d-none">
                                            <th id="count" scope="row"></th>
                                            <td id="price"></td>
                                            <td id="qty"></td>
                                            <td id="accetta">
                                                <button class="btn btn-primary mb-2" type="button"
                                                    onclick="accettaOfferta(this)">Accetta offerta</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script>
        const beforeUnloadHandler = (event) => {
            event.preventDefault();
        };
        const error = document.getElementById("error");
        function loadPagina() {
            checkLoggedInUser();
            checkIsAdmin();
        }

        function checkIsAdmin() {
            const requestOptions = {
                method: "GET",
                redirect: "follow"
            };

            fetch(`http://localhost:3000/users/${getLocalStorage("id_utente")}`, requestOptions)
                .then((response) => response.text())
                .then((result) => JSON.parse(result))
                .then((user) => {
                    if (user.nome === "admin" && user.cognome === "admin" && user.email === "admin@admin.it") {
                        document.getElementById("admin").classList.remove("d-none");
                    } else {
                        document.getElementById("user").classList.remove("d-none");
                        getOfferte();
                    }
                })
                .catch((error) => console.error(error));
        }

        async function getOfferte() {
            const requestOptions = {
                method: "GET",
                redirect: "follow"
            };

            const request = await fetch("http://localhost:3000/maxiPacchetti", requestOptions);
            const response = await request.text();
            const offerte = await JSON.parse(response).offerte;
            console.log(offerte);
            if (offerte.length === 0) {
                document.getElementById("user").innerHTML += "<h4>Non ci sono offerte disponibili al momento</h4>";
                return;
            } else {
                document.getElementById("offerte").classList.remove("d-none");
                offerte.forEach((offerta, index) => {
                    const offerteBody = document.getElementById("offerteBody");
                    const offerteRow = document.getElementById("offerteRow").cloneNode(true);
                    offerteRow.id = `offerteRow${index}`;
                    offerteRow.classList.remove("d-none");
                    offerteRow.querySelector("#count").innerHTML = index + 1;
                    offerteRow.querySelector("#price").innerHTML = offerta.price;
                    offerteRow.querySelector("#qty").innerHTML = offerta.n_figurine;
                    offerteRow.querySelector("#accetta").querySelector("button").setAttribute("data-id", offerta._id);
                    offerteBody.appendChild(offerteRow);
                });
            }
        }

        function accettaOfferta(btn) {
            window.addEventListener("beforeunload", beforeUnloadHandler);
            const bottoni = document.getElementsByClassName("btn");
            for (let i = 0; i < bottoni.length; i++) {
                bottoni[i].classList.add("disabled");
            }
            error.classList.remove("d-none", "alert-danger", "alert-success");
            error.classList.add("alert-warning");
            error.innerHTML = "Acquisto in corso attendere...";
            const myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");

            const raw = JSON.stringify({
                "id_offerta": btn.getAttribute("data-id"),
                "id_acquirente": getLocalStorage("id_utente")
            });

            const requestOptions = {
                method: "DELETE",
                headers: myHeaders,
                body: raw,
                redirect: "follow"
            };

            fetch("http://localhost:3000/maxiPacchetti", requestOptions)
                .then((response) => response.text())
                .then((result) => JSON.parse(result))
                .then((offerta) => {
                    console.log(offerta);
                    error.classList.remove('d-none', 'alert-danger', 'alert-warning');
                    error.classList.add('alert-success');
                    error.innerHTML = 'Acquisto completato!';
                    for (let i = 0; i < bottoni.length; i++) {
                        bottoni[i].classList.remove("disabled");
                    }

                    window.setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                })
                .catch((e) => {
                    console.error(e);
                    error.classList.remove("d-none");
                    error.classList.add("alert-danger");
                    error.innerHTML = "Non hai abbastanza crediti per acquistare questa bustina!";
                }).finally(() => {
                    window.removeEventListener("beforeunload", beforeUnloadHandler);
                });
        }

        function creaOfferta() {
            const price = document.getElementById("price");
            const nFigurine = document.getElementById("nFigurine");

            if (!price.checkValidity() || !price.value) {
                error.classList.remove("d-none");
                error.innerHTML = "Inserire un prezzo valido, minimo 1 massimo 5 crediti!";
                price.focus();
                price.classList.add("border-danger");
                return;
            } else if (!nFigurine.checkValidity() || !nFigurine.value) {
                error.classList.remove("d-none");
                error.innerHTML = "Inserire un numero di figurine valido, minimo 6 massimo 30 figurine!";
                nFigurine.focus();
                nFigurine.classList.add("border-danger");
                return;
            } else {
                error.classList.add("d-none");
                nFigurine.classList.remove("border-danger");
                price.classList.remove("border-danger");
            }

            const myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");

            const raw = JSON.stringify({
                "admin": getLocalStorage("id_utente"),
                "n_figurine": parseInt(nFigurine.value),
                "price": parseInt(price.value)
            });

            const requestOptions = {
                method: "POST",
                headers: myHeaders,
                body: raw,
                redirect: "follow"
            };

            fetch("http://localhost:3000/maxiPacchetti", requestOptions)
                .then((response) => response.text())
                .then((result) => JSON.parse(result))
                .then((result) => {
                    if (!result.error) {
                        error.classList.remove("d-none", "alert-danger", "alert-warning");
                        error.classList.add("alert-success");
                        error.innerHTML = "Offerta creata con successo!";
                    } else {
                        error.classList.remove("d-none", "alert-success", "alert-warning");
                        error.classList.add("alert-danger");
                        error.innerHTML = result.error;
                    }
                })
                .catch((e) => {
                    console.error(e);
                });
        }
    </script>
</body>


</html>