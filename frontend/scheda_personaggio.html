<!doctype html>
<html lang="it" data-bs-theme="dark">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Scheda personaggio</title>
    <script type="text/javascript" src="../backend/script.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body onload="aggiorna(); aggiornaPagina()">
    <nav class="navbar bg-dark border-bottom border-body navbar-expand-lg fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="home.html">Album delle Figurine dei Super Eroi (AFSE)</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item dropdown">
                        <a id="menuFigurine" class="nav-link dropdown-toggle disabled" href="#" role="button"
                            data-bs-toggle="dropdown">
                            Gestione figurine
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="album.html">Album</a></li>
                            <li><a class="dropdown-item" href="crea_scambio.html">Crea Scambio</a></li>
                            <li><a class="dropdown-item" href="lista_scambi.html">Scambi disponibili</a></li>
                            <li><a class="dropdown-item" href="acquisto_bustine.html">Acquisto bustine</a></li>
                            <li><a class="dropdown-item" href="maxi_pacchetti.html">Maxi pacchetti</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a id="menuUtente" class="nav-link dropdown-toggle disabled" href="#" role="button"
                            data-bs-toggle="dropdown">
                            Gestione utente
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="modifica_utente.html">Modifica dati</a></li>
                            <li><a class="dropdown-item" href="elimina_utente.html">Elimina Utente</a></li>
                            <li><a class="dropdown-item" href="#" onclick="sign_out();">Log out</a></li>
                            <li><a class="dropdown-item" href="login.html">Log in</a></li>
                        </ul>
                    </li>
                </ul>
                <span id="benvenuto" class="navbar-text mx-3 d-none"></span>
                <a id="salvadanaio" class="btn btn-outline-light d-none" type="button" href="acquisto_crediti.html"></a>
            </div>
        </div>
    </nav>
    <div id="container" class="container">
        <h1 class="text-center mb-2">Descrizione personaggio</h1>

        <div id="placeholder" class="card m-3">
            <div class="row">
                <div class="col-md-4">
                    <div class="figure">
                        <img class="rounded-start figure-img" src="https://placehold.co/450X750/4A4E52/4A4E52/png">
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card-body">
                        <h5 class="card-title">
                            <span class="placeholder col-6"></span>
                        </h5>
                        <p class="card-text">
                        <p class="card-text placeholder-glow">
                            <span class="placeholder col-7"></span>
                            <span class="placeholder col-4"></span>
                            <span class="placeholder col-4"></span>
                            <span class="placeholder col-6"></span>
                            <span class="placeholder col-8"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div id="heroCard" class="card d-none m-3">
            <div class="row g-0">
                <div class="col-md-4">
                    <img class="img-fluid rounded-start" alt="...">
                </div>
                <div class="col-md-8">
                    <div class="card-body">
                        <h5 class="card-title"></h5>
                        <p class="card-text"></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row row-cols-lg-3 row-cols-md-2 row-cols-1">
            <div id="col_comics" class="col">
                <h1 id="title_comics" class="text-center my-3 d-none">Fumetti</h1>
                <div id="carousel_comics" class="carousel slide">
                    <div id="container_comics" class="carousel-inner">
                    </div>
                    <button id="prev_comics" class="carousel-control-prev d-none" type="button"
                        data-bs-target="#carousel_comics" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button id="next_comics" class="carousel-control-next d-none" type="button"
                        data-bs-target="#carousel_comics" data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
                <nav>
                    <ul class="pagination pagination d-flex justify-content-center mt-2">
                        <li id="page_prev_comics" class="page-item disabled"><a class="page-link" href="#"
                                onclick="paginazioneCarousel('comics', -1);">Precedente</a>
                        </li>
                        <li id="page_next_comics" class="page-item disabled"><a class="page-link" href="#"
                                onclick="paginazioneCarousel('comics', 1);">Succesiva</a>
                        </li>
                    </ul>
                </nav>
            </div>
            <div id="col_series" class="col">
                <h1 id="title_series" class="text-center my-3 d-none">Serie</h1>
                <div id="carousel_series" class="carousel slide">
                    <div id="container_series" class="carousel-inner">
                    </div>
                    <button id="prev_series" class="carousel-control-prev d-none" type="button"
                        data-bs-target="#carousel_series" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button id="next_series" class="carousel-control-next d-none" type="button"
                        data-bs-target="#carousel_series" data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
                <nav>
                    <ul class="pagination pagination d-flex justify-content-center mt-2">
                        <li id="page_prev_series" class="page-item disabled"><a class="page-link" href="#"
                                onclick="paginazioneCarousel('series', -1);">Precedente</a>
                        </li>
                        <li id="page_next_series" class="page-item disabled"><a class="page-link" href="#"
                                onclick="paginazioneCarousel('series', 1);">Succesiva</a>
                        </li>
                    </ul>
                </nav>
            </div>

            <div id="col_events" class="col">
                <h1 id="title_events" class="text-center my-3 d-none">Eventi</h1>
                <div id="carousel_events" class="carousel slide">
                    <div id="container_events" class="carousel-inner">
                    </div>
                    <button id="prev_events" class="carousel-control-prev d-none" type="button"
                        data-bs-target="#carousel_events" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button id="next_events" class="carousel-control-next d-none" type="button"
                        data-bs-target="#carousel_events" data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
                <nav>
                    <ul class="pagination pagination d-flex justify-content-center mt-2">
                        <li id="page_prev_events" class="page-item disabled"><a class="page-link" href="#"
                                onclick="paginazioneCarousel('events', -1);">Precedente</a>
                        </li>
                        <li id="page_next_events" class="page-item disabled"><a class="page-link" href="#"
                                onclick="paginazioneCarousel('events', 1);">Succesiva</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
        <div id="slide_carrousel" class="carousel-item d-none">
            <img src="" class="d-block img-carousel">
        </div>

        <div id="placeholder_carrousel" class="d-none">
            <h1 class="placeholder-glow">
                <span class="placeholder col-12"></span>
            </h1>
            <figure class="figure">
                <img src="https://placehold.co/450X600/4A4E52/4A4E52/png" class="figure-img img-fluid rounded"
                    alt="placeholder">
            </figure>
        </div>
    </div>

    <script>
        //variabili per la paginazione dei dati del carrousel
        const dimCarrousel = 5;
        //numero di pagina per ogni tipo di carrousel
        const pageNumbers = new Map();
        pageNumbers.set('comics', 0);
        pageNumbers.set('series', 0);
        pageNumbers.set('events', 0);

        //numero di item nel server per ogni tipo di carrousel
        const maxNumber = new Map();
        maxNumber.set('comics', undefined);
        maxNumber.set('series', undefined);
        maxNumber.set('events', undefined);

        //mappa per la gestione delle URI
        const URIMap = new Map();
        URIMap.set('comics', '');
        URIMap.set('series', '');
        URIMap.set('events', '');

        function aggiorna() {
            const searchParams = new URLSearchParams(location.search);
            URI = searchParams.get('URI');

            addPlaceholder('comics');
            addPlaceholder('series');
            addPlaceholder('events');

            getFromMarvel(URI, "")
                .then((result) => popolaScehda(result.data.results))
                .catch((error) => console.error(error));
        }

        function addPlaceholder(type) {
            const placeholder = document.getElementById('placeholder_carrousel');
            //const col = document.getElementById('col_' + type);
            const container = document.getElementById('container_' + type);
            container.innerHTML = "";
            clone = placeholder.cloneNode(true);
            clone.id = 'placeholderClone_' + type;
            clone.classList.remove('d-none');
            container.append(clone);

            document.getElementById('prev_' + type).classList.add('d-none');
            document.getElementById('next_' + type).classList.add('d-none');

            document.getElementById('title_' + type).classList.add('d-none');
        }

        function popolaScehda(dati) {
            console.log(dati);
            heroCard = document.getElementById('heroCard');
            heroCard.classList.remove('d-none');

            hero = dati[0];

            title = heroCard.getElementsByClassName('card-title')[0];
            image = heroCard.getElementsByClassName('img-fluid')[0];
            description = heroCard.getElementsByClassName('card-text')[0];

            title.innerHTML = hero.name;
            image.src = hero.thumbnail.path + "." + hero.thumbnail.extension;
            description.innerHTML = hero.description;
            document.getElementById('container').replaceChild(heroCard, document.getElementById('placeholder'));

            URIMap.set('comics', hero.comics.collectionURI);
            URIMap.set('series', hero.series.collectionURI);
            URIMap.set('events', hero.events.collectionURI);

            richiestaMarvelCarousel('comics');
            richiestaMarvelCarousel('series');
            richiestaMarvelCarousel('events');
        }

        function richiestaMarvelCarousel(type) {
            var orderBy = type !== 'events' ? 'title' : 'name';
            var page = pageNumbers.get(type);
            var max = maxNumber.get(type);

            var URI = URIMap.get(type);
            URI = URI.slice(URI.indexOf(1) + 2);
            //fetch portale marvel
            getFromMarvel(URI, `orderBy=${orderBy}&limit=${dimCarrousel}&offset=${page * dimCarrousel}`)
                .then((result) => {
                    if (result.data.results.length === 0) {
                        var title = document.getElementById('title_' + type);
                        title.classList.remove('d-none');
                        title.innerHTML = `Nessun ${type} trovato`;
                    } else {
                        if (max === undefined) {
                            maxNumber.set(type, result.data.total);
                        }
                        popolacarousel(result.data.results, type);
                    }
                })
                .catch((error) => console.error(error));
        }

        function paginazioneCarousel(type, offset) {
            pageNumbers.set(type, pageNumbers.get(type) + offset);
            document.getElementById('page_prev_' + type).classList.add('disabled');
            document.getElementById('page_next_' + type).classList.add('disabled');
            addPlaceholder(type);
            richiestaMarvelCarousel(type);
        }

        function popolacarousel(data, type) {
            console.log(data);
            const slide = document.getElementById('slide_carrousel');
            const container = document.getElementById('container_' + type);
            const header = document.getElementById('title_' + type);
            const btn_prev = document.getElementById('prev_' + type);
            const btn_next = document.getElementById('next_' + type);
            const col = document.getElementById('col_' + type);


            container.innerHTML = "";
            for (i = 0; i < data.length; i++) {
                element = data[i];
                clone = slide.cloneNode(true);
                clone.id = 'slideClone_' + i;

                image = clone.getElementsByClassName('img-carousel')[0];

                image.src = element.thumbnail.path + "." + element.thumbnail.extension;

                header.classList.remove('d-none');
                clone.classList.remove('d-none');
                col.classList.remove('d-none');
                if (i === 1) {
                    btn_next.classList.remove('d-none');
                    btn_prev.classList.remove('d-none');
                }
                if (i === 0) {
                    clone.classList.add('active');
                }
                container.appendChild(clone);
            }

            //aggiorna paginazione
            const page_prev = document.getElementById('page_prev_' + type);
            const page_next = document.getElementById('page_next_' + type);

            if (pageNumbers.get(type) !== 0) {
                page_prev.classList.remove('disabled');
            }

            if (pageNumbers.get(type) * dimCarrousel + dimCarrousel < maxNumber.get(type)) {
                page_next.classList.remove('disabled');
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>

</html>